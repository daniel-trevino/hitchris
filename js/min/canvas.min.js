function preventDefault(e){e=e||window.event,e.preventDefault&&(e.preventDefault(),e.returnValue=!1)}function checkForChanges(){$("div.map").hasClass("open")?(console.log("Draws the map again since the morph-content is open"),start($("div.morph-content").width())):(console.log("The morph-content is closed, it should re-draw the map"),start(0))}function start(e){checkWhichLocation(),speed=0,reqAnimFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame,c=document.getElementById("canvas"),ctx=c.getContext("2d");var a=window.devicePixelRatio||1;ctx.canvas.width=window.innerWidth-e,ctx.canvas.height=window.innerHeight,c.style.width=c.width+"px",c.style.height=c.height+"px",c.width*=a,c.height*=a,plane=new Image,plane.onload=animate,loaded=!0,viewPort=calcMapViewPort(window[$("div.locator").data("location")]),plane._x=viewPort.x,plane._y=viewPort.y,plane.src="/img/map.svg",ctx.scale(a,a),animate(),checkStatusOfSpeed()}function animate(){plane._x<destiny.x&&0!=speed?(plane._x+=speed,plane._y=calcY(plane._x),plane._x>=destiny.x&&0!=speed&&(plane._x=destiny.x,plane._y=destiny.y,speed=0,enableScroll(),viewPort=calcMapViewPort(window[$("div.locator").data("location")]))):0!=speed&&(plane._x+=-speed,plane._y=calcY(plane._x)),draw(),isRunning&&(checkStatusOfSpeed(),reqAnimFrame(animate))}function draw(){ctx.clearRect(0,0,c.width,c.height),ctx.drawImage(plane,plane._x,plane._y)}function calcSlope(e,a){return(e.y-a.y)/(e.x-a.x)}function calcY(e){var a=calcSlope(viewPort,destiny),o;return o=a*e-a*viewPort.x+viewPort.y}function checkStatusOfSpeed(){0===speed||isRunning?0===speed&&isRunning&&(enableScroll(),isRunning=!1):(isRunning=!0,disableScroll(),animate())}function disableScroll(){window.addEventListener&&window.addEventListener("DOMMouseScroll",preventDefault,!1),window.onwheel=preventDefault,window.onmousewheel=document.onmousewheel=preventDefault,window.ontouchmove=preventDefault,document.onkeydown=preventDefaultForScrollKeys}function preventDefaultForScrollKeys(e){return keys[e.keyCode]?(preventDefault(e),!1):void 0}function enableScroll(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",preventDefault,!1),window.onmousewheel=document.onmousewheel=null,window.onwheel=null,window.ontouchmove=null,document.onkeydown=null}function calcMapViewPort(e){var a,o,n,t=document.getElementById("canvas");return o=t.width/2-e.x,o-=e.x,o/=2,n=e.y-t.height/2,n+=t.height/4,n=-n,a={name:e.name,x:o,y:n},place=e,a}function checkWhichLocation(){var e=$(window).scrollTop(),a=$(window).height();a>e&&($locator.css("opacity",0),destiny=calcMapViewPort(cuernavaca),$locator.data("location","cuernavaca").removeClass("open cuernavaca"),history.pushState("",document.title,window.location.pathname+window.location.search),$("div.map").hasClass("open")&&($map.removeClass("open loaded"),isRunning=!0,start(0))),e>=a&&2*a>e&&($locator.css("opacity",1),$map.addClass("open"),$locator.hasClass("norrkoping")&&(speed=20,$locator.removeClass("norrkoping")),$locator.data("location","cuernavaca").addClass("open cuernavaca"),destiny=calcMapViewPort(cuernavaca),window.location.hash="#cuernavaca",checkStatusOfSpeed(),$("div.map").hasClass("open")&&$("div.morph-content").is(":visible")&&!$map.hasClass("loaded")&&($map.addClass("loaded"),isRunning=!0,start(360))),e>=2*a&&3*a>e&&($locator.hasClass("cuernavaca")?(speed=20,$locator.removeClass("cuernavaca")):$locator.hasClass("stockholm")&&(speed=1,$locator.removeClass("stockholm")),$locator.data("location","norrkoping").addClass("open norrkoping"),destiny=calcMapViewPort(norrkoping),window.location.hash="#norrkoping",checkStatusOfSpeed()),e>=3*a&&4*a>e&&($locator.hasClass("norrkoping")?(speed=1,$locator.removeClass("norrkoping")):$locator.hasClass("uppsala")&&(speed=.1,$locator.removeClass("uppsala")),$locator.data("location","stockholm").addClass("open stockholm"),destiny=calcMapViewPort(stockholm),window.location.hash="#stockholm",checkStatusOfSpeed()),e>=4*a&&5*a>e&&($locator.hasClass("stockholm")?(speed=.1,$locator.removeClass("stockholm")):$locator.hasClass("munich")&&(speed=1,$locator.removeClass("munich")),$locator.data("location","uppsala").addClass("open uppsala"),destiny=calcMapViewPort(uppsala),window.location.hash="#uppsala",checkStatusOfSpeed()),e>=5*a&&6.5*a>e&&($locator.hasClass("uppsala")&&$locator.removeClass("uppsala"),$locator.data("location","munich").addClass("open munich"),destiny=calcMapViewPort(munich),window.location.hash="#munich",speed=2,checkStatusOfSpeed()),e>=6.5*a&&(window.location.hash="#footer")}var $window=$(window),$locator=$(".locator"),$map=$(".map"),cuernavaca={name:"cuernavaca",x:1042,y:1672},norrkoping={name:"norrkoping",x:2788,y:869},stockholm={name:"stockholm",x:2821,y:847},uppsala={name:"uppsala",x:2817,y:830},munich={name:"munich",x:2726,y:1133},speed=0,isRunning=!0,c,ctx,reqAnimFrame,plane,destiny,viewPort;$(window).load(function(){$window.trigger("scroll"),$window.trigger("resize")}),$(window).ready(function(){}),$(document).ready(function(){window.scrollTo(0,0)}),$(window).scroll(function(){checkWhichLocation()}),$(window).resize(function(){start($("div.map").hasClass("open")?$("div.morph-content").width():0)});var keys={37:1,38:1,39:1,40:1};